<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History - Smart Health Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Nav -->
    <nav class="bg-white shadow-lg fixed w-full z-40 top-0">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/dashboard" class="text-2xl font-bold text-green-600">ü©∫ Health</a>
            <div class="flex space-x-4">
                <a href="/dashboard" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Dashboard</a>
                <button id="logoutBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Logout</button>
            </div>
        </div>
    </nav>

    <div class="pt-20 pb-20 px-4 max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">üìã Analysis History</h1>
            <button id="clearAllBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg">
                üóëÔ∏è Clear All History
            </button>
        </div>

        <div id="historyContainer" class="space-y-4">
            <p class="text-gray-500 text-center py-12 text-lg">Loading history...</p>
        </div>
    </div>

    <script>
        class HistoryManager {
            constructor() {
                this.token = localStorage.getItem('token');
                if (!this.token) {
                    window.location.href = '/login';
                    return;
                }
                this.historyData = JSON.parse(localStorage.getItem('healthHistory') || '[]');
                this.loadHistory();
                this.bindEvents();
            }

            loadHistory() {
                this.renderHistory(this.historyData);
            }

            renderHistory(history) {
                const container = document.getElementById('historyContainer');
                
                if (history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-20">
                            <div class="text-6xl mb-6 mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center">üìù</div>
                            <h2 class="text-2xl font-bold text-gray-600 mb-2">No Analysis History</h2>
                            <p class="text-gray-500">Your symptom analyses will appear here</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = history.map((item, index) => `
                    <div class="bg-white rounded-3xl p-8 mb-6 shadow-2xl hover:shadow-3xl transition-all border-l-6 border-green-500 hover:border-green-600">
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex-1">
                                <h3 class="font-bold text-2xl text-gray-800 mb-3 line-clamp-2">${item.symptoms}</h3>
                                <p class="text-3xl font-bold bg-gradient-to-r from-green-500 to-emerald-600 bg-clip-text text-transparent">${item.disease}</p>
                            </div>
                            <span class="text-lg bg-green-100 text-green-800 px-4 py-2 rounded-full font-semibold">${new Date(item.timestamp).toLocaleDateString('en-IN')}</span>
                        </div>
                        
                        <div class="flex flex-wrap gap-3 mb-8">
                            <span class="px-6 py-3 bg-blue-100 text-blue-800 rounded-2xl text-lg font-bold">LOW</span>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="viewDetails('${btoa(JSON.stringify(item.details || item))}')" 
                                    class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 px-8 rounded-2xl font-bold text-lg shadow-2xl hover:shadow-3xl hover:scale-105 transition-all">
                                üëÅÔ∏è View Full Details
                            </button>
                            <button onclick="deleteItem(${index})" 
                                    class="bg-gradient-to-r from-red-500 to-rose-600 text-white py-4 px-8 rounded-2xl font-bold text-lg shadow-2xl hover:shadow-3xl hover:scale-105 transition-all">
                                üóëÔ∏è Remove
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            bindEvents() {
                document.getElementById('logoutBtn').onclick = () => {
                    localStorage.clear();
                    window.location.href = '/login';
                };
            }
        }

        // ‚úÖ FIXED GLOBAL FUNCTIONS
        function viewDetails(encodedDetails) {
            console.log('üëÅÔ∏è Viewing details');
            localStorage.setItem('viewHistoryDetails', encodedDetails);
            window.location.href = '/dashboard';
        }

        function deleteItem(index) {
            if (confirm('Delete this analysis from history?')) {
                let history = JSON.parse(localStorage.getItem('healthHistory') || '[]');
                history.splice(index, 1);
                localStorage.setItem('healthHistory', JSON.stringify(history));
                new HistoryManager();
                alert('‚úÖ Removed from history!');
            }
        }

        // ‚úÖ FIXED Clear All
        document.getElementById('clearAllBtn').onclick = function() {
            if (confirm('Clear ALL history? This cannot be undone.')) {
                localStorage.removeItem('healthHistory');
                new HistoryManager();
                alert('‚úÖ All history cleared!');
            }
        };

        new HistoryManager();
</script>


</body>
</html>

